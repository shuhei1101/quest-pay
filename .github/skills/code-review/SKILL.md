---
name: code-review
description: This skill should be used when reviewing code changes, pull requests, or validating implementation quality. It provides a comprehensive checklist based on coding standards and architectural patterns.
---

# Code Review

## Overview

このスキルは、お小遣いクエストボードプロジェクトのコードレビュー時に確認すべき項目を提供する。コーディング規約とアーキテクチャパターンに基づいた包括的なチェックリストを使用して、コード品質を維持する。

## レビュープロセス

### 1. コーディング規約の確認

**基本ルール**:
- [ ] すべてのコメントとPR説明が日本語で書かれているか
- [ ] セミコロンが使用されていないか
- [ ] YAGNI原則に従い、不要な分割や型定義がないか
- [ ] `index.ts`が不要に作成されていないか
- [ ] 仮ファイルは`tmp/`ディレクトリに配置されているか

**型定義**:
- [ ] `type`が優先的に使用されているか（`interface`は拡張性が必要な場合のみ）
- [ ] `entity.ts`の型を適切に参照しているか
- [ ] DBカラムと同じ意味の変数は`entity.ts`の型を参照しているか
- [ ] 重複した型定義が存在しないか

**関数とコンポーネント**:
- [ ] 関数は`const`で定義されているか（`function`は特別な理由がある場合のみ）
- [ ] コンポーネントは`const`で定義されているか（`export default`のpage.tsx以外）
- [ ] Props定義はインラインで書かれているか（不要なtype定義がないか）

**コメント**:
- [ ] 関数コメントは動詞形式（`~する`）で書かれているか
- [ ] JSX内に適切なコメントが配置されているか
- [ ] コードの横にコメントが不要に書かれていないか

**命名**:
- [ ] 閲覧画面は`〇〇View`で命名されているか
- [ ] 編集画面は`〇〇Edit`で命名されているか
- [ ] フックは`useXxx`形式で命名されているか

**JSXレイアウト**:
- [ ] フローティング部品（ポップアップ、フローティングボタン）は親JSX要素の一番下に配置されているか

### 2. アーキテクチャパターンの確認

**フロントエンド構造**:
- [ ] `page.tsx`はリダイレクトのみを担当しているか（サーバーコンポーネント）
- [ ] `XxxScreen.tsx`が画面実装を担当しているか
- [ ] `XxxLayout.tsx`が引数で受け取ったデータのみを表示しているか（API呼び出しがないか）

**API構造**:
- [ ] `client.ts`と`route.ts`がセットで作成されているか
- [ ] `client.ts`は複雑な処理を含まず、route.tsを呼び出すだけになっているか
- [ ] `route.ts`は適切にservice.ts/query.ts/db.tsを呼び分けているか
- [ ] トランザクションが必要な場合に`service.ts`が使用されているか

**フック**:
- [ ] フックは`client.ts`経由でAPIを呼び出しているか
- [ ] `useQuery`または`useMutation`が使用されているか
- [ ] フック名は`useXxx`形式か

**DBアクセス**:
- [ ] Drizzleの低レベルクエリが使用されているか（高レベルクエリは禁止）
- [ ] 排他制御が必要な場合に`db_helper.ts`が使用されているか
- [ ] 複雑な読み取りクエリは`query.ts`に分離されているか

### 3. よくある間違いパターン

**避けるべきパターン**:
- ❌ 一箇所でしか使わない型を`type XxxParams`として定義する
- ❌ `db.query.xxx.findFirst`などの高レベルクエリを使用する
- ❌ `XxxLayout.tsx`内で直接APIを呼び出す
- ❌ フックから直接`route.ts`を呼び出す（`client.ts`を経由すべき）
- ❌ `interface`を理由なく使用する（`type`を優先）
- ❌ `function`キーワードで関数を定義する（page.tsx以外）
- ❌ Props型を分離してexportする（インラインで定義すべき）
- ❌ セミコロンを使用する

**推奨パターン**:
- ✅ 必要になったタイミングで型を定義する
- ✅ Drizzleの低レベルクエリ（`db.select().from().where()`など）を使用する
- ✅ レイアウトコンポーネントはデータ表示のみに専念する
- ✅ フック → client.ts → route.ts の流れを守る
- ✅ 理由がない場合は`type`を使用する
- ✅ 関数は`const`で定義する
- ✅ Props定義はインラインで行う
- ✅ セミコロンは使用しない

### 4. レビューフィードバックの書き方

**フィードバック形式**:
```markdown
## コーディング規約違反

- [ ] ファイル名: `path/to/file.ts`
  - **問題**: セミコロンが使用されている
  - **修正**: セミコロンを削除すること

## アーキテクチャ違反

- [ ] ファイル名: `path/to/Layout.tsx`
  - **問題**: レイアウトコンポーネント内で直接APIを呼び出している
  - **修正**: データは引数で受け取り、API呼び出しは親コンポーネントで行うこと

## 改善提案

- [ ] ファイル名: `path/to/file.ts`
  - **提案**: この型定義は一箇所でしか使われていないため、インライン化を検討すること
```

## レビューチェックリスト

新しいPRをレビューする際は、以下の順序で確認する:

1. **第一印象**: コードの可読性と構造を確認
2. **コーディング規約**: 上記の「コーディング規約の確認」セクションを参照
3. **アーキテクチャ**: 上記の「アーキテクチャパターンの確認」セクションを参照
4. **よくある間違い**: 上記の「よくある間違いパターン」セクションを参照
5. **テスト**: テストが適切に書かれているか（該当する場合）
6. **パフォーマンス**: 明らかなパフォーマンス問題がないか
7. **セキュリティ**: 入力値の検証やエラーハンドリングが適切か
